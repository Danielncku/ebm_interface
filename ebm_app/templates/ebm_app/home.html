{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>IDH_EBMæ¨¡å‹ç—…äººç‰¹å¾µè§£é‡‹ç³»çµ±</title>
    <style>
        /* 
         * å…¨åŸŸé è¨­ï¼šå°‡æ‰€æœ‰å…ƒç´ çš„ margin / padding æ­¸é›¶ï¼Œ
         * ä¸¦å•Ÿç”¨ border-box æ–¹ä¾¿è¨ˆç®—å¯¬é«˜ï¼ˆå« borderã€paddingï¼‰
         */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 
         * bodyï¼šæ•´é«”å­—å‹ã€èƒŒæ™¯è‰²ã€ä»¥åŠé«˜åº¦èˆ‡æ²å‹•è¨­å®š
         * height: 100vh è®“ä¸»ç•«é¢å‰›å¥½ä½”æ»¿æ•´å€‹ viewport é«˜åº¦
         * overflow: hidden é¿å…æ•´é å‡ºç¾æ²è»¸ï¼ˆå…§å®¹åªåœ¨å…§éƒ¨å€å¡Šæ²å‹•ï¼‰
         */
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #F8F9FA;
            height: 100vh;
            overflow: hidden;
        }

        /* å³ä¸Šè§’ logo å€å¡Šå®¹å™¨ï¼šå›ºå®šåœ¨ç•«é¢å³ä¸Šè§’ */
        .logo-container {
            position: fixed;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000; /* ç¢ºä¿æµ®åœ¨æœ€ä¸Šå±¤ */
            background: rgba(255, 255, 255, 0.98);
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #E0E0E0;
        }

        /* å³ä¸Šè§’ logo åœ–ç‰‡ï¼šæ§åˆ¶é«˜åº¦ï¼Œä½¿ç”¨ mix-blend-mode è®“åº•è‰²èåˆ */
        .logo-container img {
            height: 35px;
            mix-blend-mode: multiply;
        }

        /* å³ä¸Šè§’ã€Œæˆå¤§é†«é™¢ã€æ–‡å­—æ¨£å¼ */
        .logo-text {
            font-size: 16px;
            font-weight: 600;
            color: #212121;
        }
 
        /* é ‚éƒ¨æ¨™é¡Œå€ï¼šæ¼¸å±¤èƒŒæ™¯èˆ‡ç°¡å–®é™°å½± */
        .header {
            background: linear-gradient(135deg, #90abf0ff 0%, #768ad9ff 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(58, 111, 247, 0.2);
        }

        /* ä¸»æ¨™é¡Œæ¨£å¼ */
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        /* å‰¯æ¨™é¡Œæ¨£å¼ */
        .header p {
            font-size: 1em;
            opacity: 0.95;
        }

        /* 
         * ä¸»å®¹å™¨ï¼šå·¦å³åˆ†å‰²çš„å¤–æ¡†
         * height: calc(100vh - 90px) å°‡ header é«˜åº¦æ‰£æ‰ï¼Œè®“å…§å®¹å‰›å¥½å¡«æ»¿å‰©é¤˜ç©ºé–“
         * gap: å€å¡Šé–“è·
         */
        .main-container {
            display: flex;
            height: calc(100vh - 90px);
            gap: 15px;
            padding: 15px;
        }

        /* 
         * å·¦é‚Šå€å¡Šï¼šå…¨åŸŸè§£é‡‹
         * flex: 6 ä»£è¡¨åœ¨ 6:4 æ¯”ä¾‹ä¸­çš„ 6 ä»½
         */
        .left-section {
            flex: 6;
            background: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            padding: 25px;
            display: flex;
            flex-direction: column;
            border: 1px solid #E8E8E8;
        }

        /*
         * å³é‚Šå€å¡Šï¼šç—…äººé¸å–®
         * flex: 4 ä»£è¡¨åœ¨ 6:4 æ¯”ä¾‹ä¸­çš„ 4 ä»½
         */
        .right-section {
            flex: 4;
            background: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            padding: 25px;
            display: flex;
            flex-direction: column;
            border: 1px solid #E8E8E8;
        }

        /* å„å€æ¨™é¡Œï¼ˆåŒ…å« icon èˆ‡æ–‡å­—ï¼‰ */
        .section-title {
            font-size: 1.5em;
            color: #212121;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #5C7CFA;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        /* ç—…äººé¸å–®æ¨™é¡Œåº•ç·šé¡è‰²ç¨å¾®ä¸åŒï¼Œåšè¦–è¦ºå€éš” */
        .section-title-patient {
            border-bottom-color: #3A6FF7;
        }

        /* å¤–å±¤æ§åˆ¶ select èˆ‡ label çš„å€å¡Š */
        .selector-group {
            margin-bottom: 20px;
        }

        /* select çš„æ¨™ç±¤æ–‡å­—æ¨£å¼ */
        .selector-group label {
            font-weight: 600;
            color: #212121;
            display: block;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        /* ä¸‹æ‹‰å¼é¸å–®åŸºæœ¬æ¨£å¼ */
        .selector-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            font-size: 15px;
            background: #FAFAFA;
            transition: all 0.3s;
            cursor: pointer;
            color: #212121;
        }

        /* select èšç„¦æ™‚çš„æ¨£å¼ï¼šé¡è‰²åŠ æ·±ï¼‹å¤–æ¡†é™°å½± */
        .selector-group select:focus {
            border-color: #3A6FF7;
            outline: none;
            background: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(58, 111, 247, 0.1);
        }

        /* æ»‘é¼  hover æ™‚çš„ select æ¨£å¼ */
        .selector-group select:hover {
            border-color: #5C7CFA;
            background: #FFFFFF;
        }

        /* ç—…äºº selector è‹¥æœ‰éœ€è¦å¯åœ¨æ­¤åŠ å€‹åˆ¥æ•ˆæœï¼Œç›®å‰åƒ…ä¿ç•™çµ¦æœªä¾†æ“´å……ç”¨ */
        .selector-group.patient-selector select:focus {
            border-color: #3A6FF7;
        }

        /* 
         * æŸ¥çœ‹ç—…äºº Dashboard çš„æŒ‰éˆ•ï¼š
         * ä½¿ç”¨æ¼¸å±¤åº•è‰²èˆ‡ box-shadow å¢åŠ ç«‹é«”æ„Ÿ
         */
        .view-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3A6FF7 0%, #5C7CFA 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(58, 111, 247, 0.25);
        }

        /* æŒ‰éˆ• hover æ•ˆæœï¼šå¾®å¾®ä¸Šæµ®ï¼‹é™°å½±åŠ æ·±ï¼‹é¡è‰²åŠ æ·± */
        .view-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(58, 111, 247, 0.35);
            background: linear-gradient(135deg, #2E5FE6 0%, #4A6CE9 100%);
        }

        /* æŒ‰éˆ• disable ç‹€æ…‹ï¼šç°è‰²ã€ç„¡æ³•é»æ“Šã€æ²’å‹•ç•« */
        .view-button:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 
         * åœ–è¡¨å®¹å™¨ï¼šä½¿ç”¨ flex:1 è®“å…¶æ’æ»¿å‰©é¤˜é«˜åº¦
         * min-height: 0 æ­é… flex æ’ç‰ˆï¼Œé¿å…å…§å®¹æ’çˆ†
         */
        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        /* ç”¨ iframe ä¾†åµŒå…¥ Plotly ç”¢ç”Ÿçš„ HTML åœ–è¡¨ */
        .chart-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }

        /* å…¨åŸŸåœ–è¡¨è¼‰å…¥ä¸­çš„æ¨£å¼ï¼šç½®ä¸­ spinner + æ–‡å­— */
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.1em;
            color: #616161;
        }

        /* è¼‰å…¥æ™‚çš„åœ“å½¢æ—‹è½‰å‹•ç•« */
        .spinner {
            border: 4px solid #E3F2FD;
            border-top: 4px solid #3A6FF7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        /* æ—‹è½‰å‹•ç•« keyframes å®šç¾© */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å³å´èªªæ˜æ¡†ï¼šæ·¡è—è‰²æ¼¸å±¤èƒŒæ™¯ï¼Œå·¦é‚Šæœ‰ä¸€æ¢æ·±è—è‰²é‚Šç·š */
        .info-box {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-left: 4px solid #3A6FF7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            color: #1565C0;
        }

        .info-box p {
            margin: 5px 0;
            line-height: 1.6;
        }

        .info-box strong {
            color: #0D47A1;
        }

        /* é¡¯ç¤ºç›®å‰å…±æœ‰å¤šå°‘ç—…äººè³‡æ–™çš„å°æç¤ºæ¡† */
        .patient-count {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            color: #2E7D32;
            margin-bottom: 15px;
            font-size: 0.95em;
            font-weight: 600;
            border: 1px solid #A5D6A7;
        }
    </style>
</head>
<body>
    <!-- å³ä¸Šè§’ Logo å€å¡Š -->
    <div class="logo-container">
        <!-- ä½¿ç”¨ Django static tag è¼‰å…¥æˆå¤§é†«é™¢ logo åœ–æª” -->
        <img src="{% static 'image/ncku_hospital_logo.png' %}" alt="æˆå¤§é†«é™¢åœ–æ¨™">
        <span class="logo-text">æˆå¤§é†«é™¢</span>
    </div>
    
    <!-- é é¢ä¸Šæ–¹æ¨™é¡Œåˆ— -->
    <div class="header">
        <h1>ğŸ¥ EBMæ¨¡å‹ç—…äººç‰¹å¾µè§£é‡‹ç³»çµ±</h1>
        <p>é€æç—…äººä½è¡€å£“é¢¨éšªé æ¸¬èˆ‡ç‰¹å¾µè§£é‡‹</p>
    </div>

    <!-- ä¸»å®¹å™¨ - å·¦å³åˆ†å‰² 6:4 -->
    <div class="main-container">
        <!-- å·¦åŠé‚Š - å…¨åŸŸè§£é‡‹ -->
        <div class="left-section">
            <h2 class="section-title">
                <span>ğŸŒ</span>
                <span>å…¨åŸŸç‰¹å¾µè§£é‡‹</span>
            </h2>

            <!-- ç‰¹å¾µé¸æ“‡ä¸‹æ‹‰å¼é¸å–®ï¼šé è¨­ç‚ºã€Œå…¨éƒ¨ç‰¹å¾µã€ -->
            <div class="selector-group">
                <label for="feature_select">é¸æ“‡ç‰¹å¾µï¼š</label>
                <select id="feature_select">
                    <option value="">å…¨éƒ¨ç‰¹å¾µ</option>
                    {% for feature in feature_cols %}
                        <!-- value ä»¥ç‰¹å¾µåç¨±ç‚ºä¸»ï¼Œå¾Œç«¯ AJAX æœƒç”¨ä¾†éæ¿¾ -->
                        <option value="{{ feature }}">{{ feature }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- åœ–è¡¨é¡¯ç¤ºå€ï¼šé è¨­å…ˆé¡¯ç¤º loadingï¼Œä¹‹å¾Œç”± iframe å¡«å…¥å…¨åŸŸåœ– -->
            <div class="chart-container">
                <!-- è¼‰å…¥ä¸­é¡¯ç¤ºï¼šspinner + æ–‡å­— -->
                <div class="loading" id="global_loading">
                    <div class="spinner"></div>
                    <div>è¼‰å…¥å…¨åŸŸè§£é‡‹åœ–è¡¨ä¸­...</div>
                </div>

                <!-- ç”¨ iframe ä¾†æ‰¿è¼‰å¾Œç«¯å›å‚³çš„ HTML åœ–è¡¨ -->
                <iframe id="global_iframe" class="chart-iframe" style="display: none;"></iframe>
            </div>
        </div>

        <!-- å³åŠé‚Š - ç—…äººé¸å–®èˆ‡èªªæ˜ -->
        <div class="right-section">
            <h2 class="section-title section-title-patient">
                <span>ğŸ‘¥</span>
                <span>ç—…äººé¸å–®</span>
            </h2>
            
            <!-- é¡¯ç¤ºç›®å‰ç—…äººè³‡æ–™ç¸½æ•¸ï¼špatient_list ç”± Django view å‚³å…¥ -->
            <div class="patient-count">
                å…±æœ‰ {{ patient_list|length }} ä½ç—…äººè³‡æ–™
            </div>

            <!-- ç—…äººä¸‹æ‹‰é¸å–®ï¼šé¸æ“‡æŸä¸€ä½ç—…äºº -->
            <div class="selector-group patient-selector">
                <label for="patient_select">é¸æ“‡ç—…äººï¼š</label>
                <select id="patient_select">
                    <option value="">è«‹é¸æ“‡ç—…äºº...</option>
                    {% for patient in patient_list %}
                        <!-- option é¡¯ç¤ºï¼šç—…äºº ID å‰é¢åŠ ã€Œç—…äººã€å­—æ¨£ -->
                        <option value="{{ patient }}">ç—…äºº {{ patient }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- æŸ¥çœ‹ç—…äººè©³ç´° Dashboard çš„æŒ‰éˆ•ï¼šé è¨­ disabledï¼Œé¸åˆ°ç—…äººå¾Œæ‰å•Ÿç”¨ -->
            <button id="view_dashboard" class="view-button" disabled>
                æŸ¥çœ‹ç—…äººè©³ç´°åˆ†æ â†’
            </button>

            <!-- å³å´èªªæ˜æ–‡å­—ï¼šç°¡å–®ä»‹ç´¹ç³»çµ±åŠŸèƒ½ -->
            <div class="info-box">
                <p><strong>ğŸ“Š ç³»çµ±åŠŸèƒ½èªªæ˜ï¼š</strong></p>
                <p>â€¢ å·¦å´é¡¯ç¤ºæ¨¡å‹çš„å…¨åŸŸç‰¹å¾µé‡è¦æ€§</p>
                <p>â€¢ é¸æ“‡ç—…äººå¾Œå¯æŸ¥çœ‹å€‹åˆ¥åˆ†æ</p>
                <p>â€¢ é»æ“ŠæŒ‰éˆ•é€²å…¥ Dashboard æŸ¥çœ‹å€åŸŸè§£é‡‹</p>
            </div>
        </div>
    </div>

    <script>
        // è¨˜éŒ„ç›®å‰é¸æ“‡çš„ç—…äººç·¨è™Ÿï¼ˆå¾ä¸‹æ‹‰é¸å–®å–å¾—ï¼‰
        let selectedPatient = null;

        // ------------------------
        // å…¨åŸŸè§£é‡‹è¼‰å…¥é‚è¼¯ï¼ˆé¦–é ä¸é¡¯ç¤ºç—…äººæ¨™è¨˜ï¼‰
        // ------------------------
        /**
         * ä¾ç…§é¸æ“‡çš„ç‰¹å¾µ(feature)è¼‰å…¥å…¨åŸŸè§£é‡‹åœ–è¡¨
         * @param {string} feature - ç‰¹å¾µåç¨±ï¼Œç©ºå­—ä¸²ä»£è¡¨ã€Œå…¨éƒ¨ç‰¹å¾µã€
         */
        function loadGlobal(feature='') {
            const loading = document.getElementById('global_loading'); // è¼‰å…¥ä¸­å€å¡Š
            const iframe = document.getElementById('global_iframe');   // æ‰¿è¼‰åœ–è¡¨çš„ iframe
            
            // åˆ‡æ›é¡¯ç¤ºç‹€æ…‹ï¼šé¡¯ç¤º loadingï¼Œéš±è— iframe
            loading.style.display = 'flex';
            iframe.style.display = 'none';

            // é€é AJAX å‘å¾Œç«¯è«‹æ±‚å…¨åŸŸè§£é‡‹ HTML
            // æ³¨æ„ï¼šé€™å€‹ endpoint åœ¨å¾Œç«¯ view ä¸­è¦å°æ‡‰å¥½
            fetch(`/ajax/global_explanation/?feature=${encodeURIComponent(feature)}`)
                .then(res => res.text())    // å°‡å›å‚³å…§å®¹è¦–ç‚ºç´”æ–‡å­—ï¼ˆHTMLï¼‰
                .then(html => {
                    // æŠŠ HTML å¯«å…¥ iframe çš„ document ä¸­
                    iframe.contentWindow.document.open();
                    iframe.contentWindow.document.write(html);
                    iframe.contentWindow.document.close();
                    
                    // è¼‰å…¥å®Œ HTML å¾Œï¼Œåˆ‡æ›é¡¯ç¤ºï¼šéš±è— loadingï¼Œé¡¯ç¤º iframe
                    loading.style.display = 'none';
                    iframe.style.display = 'block';
                    
                    // ç­‰å¾… iframe å®Œå…¨è¼‰å…¥å¾Œï¼Œå‘¼å« Plotly çš„ resize èª¿æ•´åœ–è¡¨å¤§å°
                    iframe.onload = function() {
                        try {
                            const iframeWindow = iframe.contentWindow;
                            // ç¢ºèª iframe å…§æœ‰è¼‰å…¥ Plotlyï¼ˆé˜²æ­¢éŒ¯èª¤ï¼‰
                            if (iframeWindow.Plotly) {
                                // å°‹æ‰¾æ‰€æœ‰åœ–è¡¨ divï¼ˆé€šå¸¸ class ç‚º plotly-graph-divï¼‰
                                const plotDivs = iframeWindow.document.querySelectorAll('.plotly-graph-div');
                                plotDivs.forEach(div => {
                                    iframeWindow.Plotly.Plots.resize(div);
                                });
                            }
                        } catch (e) {
                            console.log('ç„¡æ³•èª¿æ•´ Plotly åœ–è¡¨å¤§å°:', e);
                        }
                    };
                })
                .catch(error => {
                    // è‹¥è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    console.error('è¼‰å…¥å…¨åŸŸè§£é‡‹åœ–è¡¨å¤±æ•—:', error);
                    loading.innerHTML = '<div class="spinner"></div><div style="color: #F44336;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
                });
        }

        // ç›£è½ç‰¹å¾µä¸‹æ‹‰é¸å–®è®ŠåŒ–ï¼Œä¸€æ”¹è®Šå°±é‡æ–°è¼‰å…¥å…¨åŸŸè§£é‡‹åœ–
        document.getElementById('feature_select').addEventListener('change', (e) => {
            loadGlobal(e.target.value); // å°‡é¸å–çš„ç‰¹å¾µåç¨±å‚³å…¥ loadGlobal
        });

        // ç—…äººé¸å–®è®ŠåŒ–ï¼šæ›´æ–° selectedPatient ä¸¦æ§åˆ¶æŒ‰éˆ• enable/disable
        document.getElementById('patient_select').addEventListener('change', (e) => {
            selectedPatient = e.target.value;
            const button = document.getElementById('view_dashboard');
            
            if (selectedPatient) {
                // æœ‰é¸ç—…äºº â†’ å•Ÿç”¨æŒ‰éˆ•
                button.disabled = false;
            } else {
                // æ²’é¸ç—…äºº â†’ æŒ‰éˆ•ä¿æŒç„¡æ³•é»æ“Š
                button.disabled = true;
            }
        });

        // é»æ“Šã€ŒæŸ¥çœ‹ Dashboardã€æŒ‰éˆ•å¾Œï¼Œå°å‘è©²ç—…äººçš„ Dashboard é é¢
        document.getElementById('view_dashboard').addEventListener('click', () => {
            if (selectedPatient) {
                // é€™è£¡å‡è¨­å¾Œç«¯ URL pattern ç‚º /dashboard/<patient_id>/
                window.location.href = `/dashboard/${selectedPatient}/`;
            }
        });

        // è¦–çª—å¤§å°æ”¹è®Šæ™‚ï¼Œé‡æ–°èª¿æ•´ iframe è£¡ Plotly åœ–è¡¨çš„å¤§å°
        window.addEventListener('resize', function() {
            const iframe = document.getElementById('global_iframe');
            // ç¢ºä¿ iframe æœ‰é¡¯ç¤ºå‡ºä¾†æ‰éœ€è¦ resize
            if (iframe && iframe.style.display !== 'none') {
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow.Plotly) {
                        const plotDivs = iframeWindow.document.querySelectorAll('.plotly-graph-div');
                        plotDivs.forEach(div => {
                            iframeWindow.Plotly.Plots.resize(div);
                        });
                    }
                } catch (e) {
                    console.log('ç„¡æ³•èª¿æ•´åœ–è¡¨å¤§å°:', e);
                }
            }
        });

        // é é¢è¼‰å…¥å®Œæˆå¾Œï¼Œé è¨­è¼‰å…¥ã€Œå…¨éƒ¨ç‰¹å¾µã€çš„å…¨åŸŸè§£é‡‹åœ–
        document.addEventListener('DOMContentLoaded', function() {
            loadGlobal();
        });
    </script>
</body>
</html>
